<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>çš“éˆ Ã— Sunnyï½œäº¤å¾€å¤©æ•¸</title>
  <style>
    :root{
      --bg:#0f172a;--card:#111827cc;--text:#e5e7eb;--accent:#f472b6;--accent2:#60a5fa;--muted:#9ca3af;
    }
    html,body{height:100%}
    body{
      margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,Noto Sans,Apple Color Emoji,Segoe UI Emoji;
      background:radial-gradient(1200px 800px at 20% -10%, #1f2937, transparent),
                 radial-gradient(1000px 700px at 120% 10%, #0b1020, transparent),var(--bg);
      color:var(--text);display:flex;align-items:center;justify-content:center;min-height:100vh;padding:24px;
    }
    .app{width:100%;max-width:980px;position:relative}
    .glass{background:linear-gradient(180deg, #ffffff10, #ffffff05);border:1px solid #ffffff22;border-radius:24px;backdrop-filter: blur(10px);box-shadow:0 10px 30px #00000050;overflow:hidden}
    header{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:20px 24px;border-bottom:1px solid #ffffff1a}
    header h1{font-size:20px;margin:0;letter-spacing:.5px}
    header .hint{font-size:12px;color:var(--muted)}

    .grid{display:grid;grid-template-columns:1.05fr 1fr;gap:16px;padding:16px}
    @media (max-width:900px){.grid{grid-template-columns:1fr}}

    .card{background:var(--card);border:1px solid #ffffff1a;border-radius:18px;padding:16px}
    .card h2{margin:0 0 8px;font-size:16px;color:#fff}
    label{display:block;font-size:12px;color:var(--muted);margin:12px 0 6px}
    input[type="text"],input[type="date"],input[type="file"]{width:100%;border:1px solid #ffffff2a;background:#0b1222;color:var(--text);border-radius:10px;padding:10px 12px;font-size:14px}
    input[type="file"]{padding:8px;background:#0b1222}

    .people{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:600px){ .people{ grid-template-columns:1fr } }

    .avatar{display:flex;gap:12px;align-items:center;background:#0b1222;border:1px dashed #ffffff2a;border-radius:14px;padding:12px}
    .avatar .preview{width:56px;height:56px;border-radius:50%;background:#111827;flex:0 0 auto;overflow:hidden;border:2px solid #ffffff1a;display:grid;place-items:center}
    .avatar .preview img{width:100%;height:100%;object-fit:cover}

    .actions{display:flex;flex-wrap:wrap;gap:12px;margin-top:14px}
    button{appearance:none;background:linear-gradient(135deg,var(--accent),#ff9bd1);color:#0b1020;border:0;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer;box-shadow:0 6px 18px #00000040;transition:transform .08s ease}
    button.secondary{background:#111827;color:#e5e7eb;border:1px solid #ffffff22}
    button:disabled{opacity:.6;cursor:not-allowed}
    button:active{transform:translateY(1px)}

    /* å³å´å±•ç¤º */
    .display{position:relative;min-height:420px;display:grid;place-items:center;padding:16px;overflow:hidden}
    .stage{position:relative;width:100%;height:100%;display:grid;place-items:center}
    .pair{position:relative;display:flex;align-items:center;gap:22px;transform:translateY(-10px)}
    .bubble{width:160px;height:160px;border-radius:50%;background:linear-gradient(180deg,#ffffff18,#ffffff08);border:1px solid #ffffff2a;overflow:hidden;box-shadow:0 10px 30px #00000055}
    .bubble img{width:100%;height:100%;object-fit:cover}
    .heart{font-size:28px;animation:floatUp 4s linear infinite;position:absolute;opacity:.9;filter:drop-shadow(0 4px 8px #0008)}
    @keyframes floatUp{0%{transform:translateY(20px) scale(.8);opacity:0}10%{opacity:1}80%{opacity:1}100%{transform:translateY(-160px) scale(1.2);opacity:0}}

    .count{text-align:center;margin-top:8px}
    .count .names{font-size:14px;color:var(--muted);letter-spacing:1px}
    .count .days{font-size:64px;font-weight:900;background:linear-gradient(90deg,var(--accent2),var(--accent));-webkit-background-clip:text;background-clip:text;color:transparent;line-height:1;margin:8px 0}
    .count .sub{font-size:14px;color:#cbd5e1}

    .toast{position:fixed;left:50%;bottom:24px;transform:translateX(-50%);background:#111827cc;border:1px solid #ffffff2a;padding:10px 14px;border-radius:12px;opacity:0;pointer-events:none;transition:.25s}
    .toast.show{opacity:1;pointer-events:auto}

    .watermark{position:absolute;right:12px;bottom:10px;font-size:11px;color:#94a3b8}

    /* åˆ†äº«å›ºå®šæ¨¡å¼ */
    .fixed-mode header{display:none}
    .fixed-mode .grid{grid-template-columns:1fr;padding:0}
    .fixed-mode .display{min-height:calc(100vh - 120px);padding:32px}
    .fixed-mode .pair{gap:32px;transform:none}
    .fixed-mode .bubble{width:clamp(160px,22vw,260px);height:clamp(160px,22vw,260px)}
    .fixed-mode .count .names{font-size:clamp(18px,2.2vw,28px)}
    .fixed-mode .count .days{font-size:clamp(72px,10vw,140px)}
    .fixed-mode .actions{justify-content:center}
    .fixed-mode #startBtn{font-size:clamp(18px,2.2vw,24px);padding:16px 36px;border-radius:9999px}
    .fixed-mode .watermark{right:auto;left:50%;transform:translateX(-50%);bottom:16px}

    /* AI å·¥å…·å€ï¼ˆåªåœ¨æŒ‰ä¸‹ AI å·¥å…·æ™‚é¡¯ç¤ºï¼‰ */
    .ai-tools{display:none}
    body.ai-open .ai-tools{display:block}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <div class="app glass" role="application" aria-label="äº¤å¾€å¤©æ•¸å°å¹«æ‰‹">
    <header>
      <div>
        <h1>çš“éˆ Ã— Sunny ï½œ äº¤å¾€å¤©æ•¸ ğŸ’˜</h1>
        <div class="hint">é»ä¸€ä¸‹ã€Œé–‹å§‹ã€â†’ æ„›å¿ƒå‹•ç•« + å¤©æ•¸</div>
      </div>
      <div class="actions">
        <button id="shareBtn" class="secondary" title="è¤‡è£½åˆ†äº«é€£çµ">è¤‡è£½åˆ†äº«é€£çµ</button>
        <button id="aiToggleBtn" class="secondary" title="é¡¯ç¤º/éš±è— AI å·¥å…·">AI å·¥å…·</button>
        <button id="resetBtn" class="secondary" title="é‡è¨­è¡¨å–®">é‡è¨­</button>
      </div>
    </header>

    <div class="grid">
      <!-- å·¦ï¼šè¡¨å–® -->
      <section class="card" aria-labelledby="formTitle">
        <h2 id="formTitle">åŸºæœ¬è³‡æ–™</h2>
        <div class="people">
          <div class="avatar">
            <div class="preview" id="prevA" aria-label="A çš„ç…§ç‰‡é è¦½">ğŸ–¼ï¸</div>
            <div style="flex:1">
              <label for="nameA">å§“å A</label>
              <input id="nameA" type="text" placeholder="ä¾‹å¦‚ï¼šè¨±çš“éˆ" autocomplete="name" />
              <label for="photoA">ç…§ç‰‡ Aï¼ˆä¸Šå‚³ï¼‰</label>
              <input id="photoA" type="file" accept="image/*" />
              <!-- AI å·¥å…·ï¼ˆAï¼‰ -->
              <div class="ai-tools" aria-label="AI é¢¨æ ¼ A">
                <label><input id="useAIA" type="checkbox" />ä½¿ç”¨AIé ­åƒ</label>
                <select id="styleA" aria-label="é¢¨æ ¼">
                  <option value="qç‰ˆ">Qç‰ˆå¯æ„›</option><option value="æ¼«ç•«">æ¼«ç•«ç·šç¨¿+ä¸Šè‰²</option><option value="æ°´å½©">æ°´å½©æšˆæŸ“</option>
                  <option value="æ²¹ç•«">æ²¹ç•«åšå¡—</option><option value="3dé»åœŸ">3D é»åœŸå…¬ä»”</option><option value="åƒç´ ">8-bit åƒç´ é ­åƒ</option>
                  <option value="è³½åšé¾å…‹">è³½åšé¾å…‹éœ“è™¹</option><option value="æ—¥ç³»æ‰å¹³">æ—¥ç³»æ‰å¹³æ’ç•«</option><option value="ç«¥è©±å¡é€š">ç«¥è©±å¡é€š</option>
                </select>
                <label style="display:flex;align-items:center;gap:6px">
                  å¼·åº¦ <input id="strengthA" type="range" min="0" max="100" value="70" />
                  <span id="strengthATip">70</span>
                </label>
                <div class="actions">
                  <button id="genAIA" class="secondary" type="button">æ›æˆAIé ­åƒ</button>
                  <button id="revertA" class="secondary" type="button">é‚„åŸåŸåœ–</button>
                  <button id="uploadA" class="secondary" type="button">ä¸Šå‚³åˆ°è³‡æ–™åº«</button>
                </div>
              </div>
            </div>
          </div>
          <div class="avatar">
            <div class="preview" id="prevB" aria-label="B çš„ç…§ç‰‡é è¦½">ğŸ–¼ï¸</div>
            <div style="flex:1">
              <label for="nameB">å§“å B</label>
              <input id="nameB" type="text" placeholder="ä¾‹å¦‚ï¼šSunny" autocomplete="name" />
              <label for="photoB">ç…§ç‰‡ Bï¼ˆä¸Šå‚³ï¼‰</label>
              <input id="photoB" type="file" accept="image/*" />
              <!-- AI å·¥å…·ï¼ˆBï¼‰ -->
              <div class="ai-tools" aria-label="AI é¢¨æ ¼ B">
                <label><input id="useAIB" type="checkbox" />ä½¿ç”¨AIé ­åƒ</label>
                <select id="styleB" aria-label="é¢¨æ ¼">
                  <option value="qç‰ˆ">Qç‰ˆå¯æ„›</option><option value="æ¼«ç•«">æ¼«ç•«ç·šç¨¿+ä¸Šè‰²</option><option value="æ°´å½©">æ°´å½©æšˆæŸ“</option>
                  <option value="æ²¹ç•«">æ²¹ç•«åšå¡—</option><option value="3dé»åœŸ">3D é»åœŸå…¬ä»”</option><option value="åƒç´ ">8-bit åƒç´ é ­åƒ</option>
                  <option value="è³½åšé¾å…‹">è³½åšé¾å…‹éœ“è™¹</option><option value="æ—¥ç³»æ‰å¹³">æ—¥ç³»æ‰å¹³æ’ç•«</option><option value="ç«¥è©±å¡é€š">ç«¥è©±å¡é€š</option>
                </select>
                <label style="display:flex;align-items:center;gap:6px">
                  å¼·åº¦ <input id="strengthB" type="range" min="0" max="100" value="70" />
                  <span id="strengthBTip">70</span>
                </label>
                <div class="actions">
                  <button id="genAIB" class="secondary" type="button">æ›æˆAIé ­åƒ</button>
                  <button id="revertB" class="secondary" type="button">é‚„åŸåŸåœ–</button>
                  <button id="uploadB" class="secondary" type="button">ä¸Šå‚³åˆ°è³‡æ–™åº«</button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <label for="start">äº¤å¾€é–‹å§‹æ—¥æœŸ</label>
        <input id="start" type="date" />

        <div class="actions">
          <button id="goBtn" aria-label="é–‹å§‹">é–‹å§‹ âœ¨</button>
        </div>
        <div class="actions" style="gap:8px;margin-top:8px">
          <label><input id="heartFX" type="checkbox" checked>é¡¯ç¤ºæ„›å¿ƒç‰¹æ•ˆ</label>
        </div>
        <p style="margin:10px 2px 0;font-size:12px;color:var(--muted)">ï¼Šå¤©æ•¸ä»¥å°ç£æ™‚å€ï¼ˆAsia/Taipeiï¼‰çš„ã€Œç•¶åœ°åˆå¤œã€è¨ˆç®—ï¼Œç¬¬ 1 å¤©ç‚º Day 1ã€‚</p>
      </section>

      <!-- å³ï¼šå±•ç¤ºå€ -->
      <section class="card display" aria-live="polite">
        <div class="stage">
          <div class="pair" id="pair">
            <div class="bubble" id="bubbleA" aria-label="A çš„é ­åƒ"></div>
            <div class="bubble" id="bubbleB" aria-label="B çš„é ­åƒ"></div>
          </div>
          <div class="count" id="count">
            <div class="names" id="names">è¨±çš“éˆ Ã— Sunny</div>
            <div class="days" id="days">0</div>
            <div class="sub" id="sub">æŒ‰ä¸‹ã€Œé–‹å§‹ã€çœ‹çœ‹ä»Šå¤©ç¬¬å¹¾å¤© âœ¨</div>
            <div class="actions"><button id="startBtn">é–‹å§‹</button></div>
          </div>
          <div class="watermark">Made with ğŸ’–</div>
        </div>
      </section>
    </div>
  </div>

  <div class="toast" id="toast" role="status" aria-live="polite">å·²è¤‡è£½åˆ†äº«é€£çµ</div>

  <script>
  // ========== å°ç£æ™‚å€å¤©æ•¸ ==========
  const TZ = 'Asia/Taipei';
  function toLocalMidnight(date){
    const y = new Intl.DateTimeFormat('en-CA',{timeZone:TZ,year:'numeric'}).format(date);
    const m = new Intl.DateTimeFormat('en-CA',{timeZone:TZ,month:'2-digit'}).format(date);
    const d = new Intl.DateTimeFormat('en-CA',{timeZone:TZ,day:'2-digit'}).format(date);
    return new Date(`${y}-${m}-${d}T00:00:00+08:00`);
  }
  function daysSince(startStr){
    if(!startStr) return 0;
    const start = toLocalMidnight(new Date(startStr));
    const today = toLocalMidnight(new Date());
    return Math.floor((today - start)/86400000) + 1;
  }

  // ========== DOM ==========
  const nameA = document.getElementById('nameA');
  const nameB = document.getElementById('nameB');
  const photoA = document.getElementById('photoA');
  const photoB = document.getElementById('photoB');
  const prevA = document.getElementById('prevA');
  const prevB = document.getElementById('prevB');
  const bubbleA = document.getElementById('bubbleA');
  const bubbleB = document.getElementById('bubbleB');
  const start = document.getElementById('start');
  const goBtn = document.getElementById('goBtn');
  const daysEl = document.getElementById('days');
  const namesEl = document.getElementById('names');
  const subEl = document.getElementById('sub');
  const pair = document.getElementById('pair');
  const shareBtn = document.getElementById('shareBtn');
  const aiToggleBtn = document.getElementById('aiToggleBtn');
  const resetBtn = document.getElementById('resetBtn');
  const toast = document.getElementById('toast');
  const heartFX = document.getElementById('heartFX');

  // AI æ§åˆ¶
  const useAIA = document.getElementById('useAIA');
  const useAIB = document.getElementById('useAIB');
  const genAIA = document.getElementById('genAIA');
  const genAIB = document.getElementById('genAIB');
  const revertA = document.getElementById('revertA');
  const revertB = document.getElementById('revertB');
  const styleA = document.getElementById('styleA');
  const styleB = document.getElementById('styleB');
  const strengthA = document.getElementById('strengthA');
  const strengthB = document.getElementById('strengthB');
  const strengthATip = document.getElementById('strengthATip');
  const strengthBTip = document.getElementById('strengthBTip');

  // ========== ç‹€æ…‹ ==========
  let START_DATE = start?.value || '';
  let originalA = null, originalB = null;
  let aiA = null, aiB = null;
  let SHARE_ID = null;

  // ========== ShareId ==========
  function generateId(len=12){
    const chars='0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ';
    const arr = new Uint32Array(len); crypto.getRandomValues(arr);
    return Array.from(arr,x=>chars[x%chars.length]).join('');
  }
  function idFromPath(){ const m = location.pathname.match(/^\/c\/([A-Za-z0-9_-]{6,})/); return m?m[1]:null; }
  function ensureShareId(){
    if (SHARE_ID) return SHARE_ID;
    const p = new URLSearchParams(location.search);
    SHARE_ID = idFromPath() || p.get('id') || localStorage.getItem('share-id') || generateId();
    try{ localStorage.setItem('share-id', SHARE_ID); }catch{}
    return SHARE_ID;
  }

  // ========== Supabaseï¼ˆç”¨ /api/public-config æ‹¿å…¬é–‹è¨­å®šï¼‰==========
  let supabaseClient = null, supaConfig = null;
  async function loadSupaConfig(){
    if (supaConfig) return supaConfig;
    const r = await fetch('/api/public-config');
    const j = await r.json();
    if(!j?.supabaseUrl || !j?.supabaseAnon) throw new Error('ç¼ºå°‘ Supabase è¨­å®š');
    supaConfig = j; return supaConfig;
  }
  async function ensureSupabase(){
    if (supabaseClient) return supabaseClient;
    const { supabaseUrl, supabaseAnon } = await loadSupaConfig();
    supabaseClient = window.supabase.createClient(supabaseUrl, supabaseAnon);
    return supabaseClient;
  }

  // ========== é è¦½ä¸Šå‚³ ==========
  if(photoA) photoA.addEventListener('change', e => preview(e.target.files[0], prevA, bubbleA, 'A'));
  if(photoB) photoB.addEventListener('change', e => preview(e.target.files[0], prevB, bubbleB, 'B'));
  function preview(file, previewNode, bubbleNode, which){
    if(!file){ previewNode.innerHTML='ğŸ–¼ï¸'; bubbleNode.style.backgroundImage='none'; return; }
    const reader = new FileReader();
    reader.onload = e => {
      const url = e.target.result;
      previewNode.innerHTML = `<img alt="é è¦½" src="${url}">`;
      bubbleNode.style.backgroundImage = `url("${url}")`;
      bubbleNode.style.backgroundSize = 'cover';
      bubbleNode.style.backgroundPosition = 'center';
      if(which==='A') originalA = url; else originalB = url;
    };
    reader.readAsDataURL(file);
  }

  // ========== å·¥å…· ==========
  function showToast(text){ toast.textContent=text; toast.classList.add('show'); setTimeout(()=>toast.classList.remove('show'),1800); }
  function getCurrentBubble(bubble){
    const bg = bubble.style.backgroundImage || getComputedStyle(bubble).backgroundImage;
    const m = bg && bg.match(/url\(["']?(.*?)["']?\)/);
    return m ? m[1] : null; // å¯èƒ½æ˜¯ dataURL æˆ– http(s)
  }
  function setBubbleFromURL(bubble,url){
    bubble.style.backgroundImage = url ? `url(${url})` : 'none';
    bubble.style.backgroundSize='cover'; bubble.style.backgroundPosition='center';
  }
  function dataURLtoBase64(dataUrl){ return dataUrl?.split(',')[1] || null; }
  async function urlToBase64(url){
    // åªæœ‰åŒæºæˆ–å…è¨± CORS çš„åœ–ç‰‡æ‰è¡Œï¼›å¦å‰‡å›å‚³ nullï¼ˆåˆ†äº«ä»æœƒå¯«å…¥å§“åæ—¥æœŸï¼‰
    try{
      const res = await fetch(url, { mode:'cors' });
      if(!res.ok) return null;
      const blob = await res.blob();
      return await new Promise(r=>{
        const fr = new FileReader(); fr.onload=()=>r(fr.result.split(',')[1]); fr.readAsDataURL(blob);
      });
    }catch{ return null; }
  }

  // ========== URL/åˆ†äº«è¼‰å…¥ ==========
  // 1) Query è¦†å¯«
  (function hydrateFromQuery(){
    const p = new URLSearchParams(location.search);
    const a = p.get('a') || ''; const b = p.get('b') || ''; const d = p.get('d') || '';
    const fixedMode = p.get('v') === '1';
    if(a) nameA.value = a; if(b) nameB.value = b; if(d){ start.value=d; START_DATE=d; }
    ensureShareId(); updateNames();
    if(fixedMode){
      document.body.classList.add('fixed-mode');
      const form = document.querySelector('section.card[aria-labelledby="formTitle"]'); if(form) form.style.display='none';
      const aName = nameA.value?.trim() || 'A'; const bName = nameB.value?.trim() || 'B';
      document.title = `${aName} Ã— ${bName}ï½œäº¤å¾€å¤©æ•¸`;
      const wm = document.querySelector('.watermark'); if(wm) wm.textContent = `Made for ${aName} & ${bName} with ğŸ’–`;
      const headerActions = document.querySelector('header .actions'); if(headerActions) headerActions.style.display='none';
    }
  })();

  // 2) /c/<id> åˆ†äº«é è‡ªå‹•è¼‰å…¥ Supabase
  (async function hydrateFromShare(){
    const id = idFromPath(); if(!id) return;
    try{
      const supa = await ensureSupabase();
      const { data, error } = await supa.from('couples').select('*').eq('slug', id).single();
      if (error) throw error;
      if (data?.name_a) nameA.value = data.name_a;
      if (data?.name_b) nameB.value = data.name_b;
      if (data?.start_date) { start.value = data.start_date; START_DATE = data.start_date; }
      updateNames();
      if (data?.photo_a_url) setBubbleFromURL(bubbleA, data.photo_a_url);
      if (data?.photo_b_url) setBubbleFromURL(bubbleB, data.photo_b_url);

      document.body.classList.add('fixed-mode');
      const headerActions = document.querySelector('header .actions'); if(headerActions) headerActions.style.display='none';
      const form = document.querySelector('section.card[aria-labelledby="formTitle"]'); if(form) form.style.display='none';
      document.title = `${nameA.value?.trim()||'A'} Ã— ${nameB.value?.trim()||'B'}ï½œäº¤å¾€å¤©æ•¸`;
      const wm = document.querySelector('.watermark'); if(wm) wm.textContent = `Made for ${nameA.value||'A'} & ${nameB.value||'B'} with ğŸ’–`;
    }catch(e){
      console.error(e); showToast('åˆ†äº«è³‡æ–™è¼‰å…¥å¤±æ•—');
    }
  })();

  // 3) LocalStorage
  (function hydrateFromLocal(){
    try{
      const raw = localStorage.getItem('love-counter'); if(!raw) return;
      const {a,b,d} = JSON.parse(raw);
      if(a) nameA.value=a; if(b) nameB.value=b; if(d) start.value=d;
      updateNames();
    }catch{}
  })();
  function persist(){ try{ localStorage.setItem('love-counter', JSON.stringify({a:nameA.value,b:nameB.value,d:start.value})); }catch{} }
  if(nameA) nameA.addEventListener('input', ()=>{updateNames();persist();});
  if(nameB) nameB.addEventListener('input', ()=>{updateNames();persist();});
  if(start)  start .addEventListener('change', ()=>{ START_DATE = start.value; persist();});

  function updateNames(){
    const a = nameA.value?.trim() || 'A';
    const b = nameB.value?.trim() || 'B';
    namesEl.textContent = `${a} Ã— ${b}`;
  }

  // ========== å¤©æ•¸ & æ„›å¿ƒ ==========
  function computeAndAnimate(){
    const d = daysSince(START_DATE);
    countUp(daysEl, d, 1000);
    subEl.textContent = `ä»Šå¤©æ˜¯äº¤å¾€ç¬¬ ${d} å¤©`;
    pulse(pair);
    if(heartFX?.checked && !window.matchMedia('(prefers-reduced-motion: reduce)').matches){
      startHeartsBurst();
    }
  }
  if(goBtn) goBtn.addEventListener('click', computeAndAnimate);
  const startBtn = document.getElementById('startBtn'); if(startBtn) startBtn.addEventListener('click', computeAndAnimate);

  function countUp(el,target,duration){
    const startVal = parseInt(el.textContent.replace(/\D/g,'')) || 0;
    const diff = target - startVal; const startTs = performance.now();
    function step(ts){ const t = Math.min(1,(ts-startTs)/duration); const ease = 1 - Math.pow(1-t,3);
      el.textContent = Math.floor(startVal + diff*ease).toLocaleString();
      if(t<1) requestAnimationFrame(step);
    }
    requestAnimationFrame(step);
  }
  function pulse(node){
    node.animate([
      {transform:'scale(1)',filter:'brightness(1)'},
      {transform:'scale(1.05)',filter:'brightness(1.2)'},
      {transform:'scale(1)',filter:'brightness(1)'},
    ],{duration:500,easing:'ease-out'});
  }
  function startHeartsBurst(){
    const colors=['#fb7185','#f472b6','#60a5fa','#22d3ee','#facc15'];
    const stage=document.querySelector('.stage'); const N=22;
    for(let i=0;i<N;i++){
      const span=document.createElement('span'); span.className='heart'; span.textContent='â¤';
      span.style.left=(10+Math.random()*80)+'%'; span.style.bottom=(Math.random()*10)+'%';
      span.style.color=colors[i%colors.length]; span.style.fontSize=(22+Math.random()*20)+'px';
      span.style.animationDelay=(Math.random()*0.6)+'s';
      stage.appendChild(span); setTimeout(()=>span.remove(),4200);
    }
  }

  // ========== AI ç”Ÿæˆ ==========
  function styleToPrompt(style){
    switch(style){
      case 'qç‰ˆ': return 'Qç‰ˆå¯æ„›ã€åœ“åœ“é ­èº«ã€æŸ”å’Œå…‰å½±ã€ä¹¾æ·¨èƒŒæ™¯ã€åœ“å½¢è£åˆ‡ã€é©åˆä½œç‚ºé ­åƒ';
      case 'æ¼«ç•«': return 'æ¼«ç•«ç·šç¨¿ï¼‹ä¸Šè‰²ã€æ¸…æ™°æé‚Šã€åœ“å½¢è£åˆ‡ã€é©åˆä½œç‚ºé ­åƒ';
      case 'æ°´å½©': return 'æ°´å½©æšˆæŸ“ã€æŸ”å’Œç­†è§¸ã€åœ“å½¢è£åˆ‡ã€é©åˆä½œç‚ºé ­åƒ';
      case 'æ²¹ç•«': return 'æ²¹ç•«åšå¡—ã€ç­†è§¸æ˜é¡¯ã€åœ“å½¢è£åˆ‡ã€é©åˆä½œç‚ºé ­åƒ';
      case '3dé»åœŸ': return '3D é»åœŸå…¬ä»”ã€ç«‹é«”é™°å½±ã€åœ“å½¢è£åˆ‡ã€é©åˆä½œç‚ºé ­åƒ';
      case 'åƒç´ ': return '8-bit åƒç´ ã€å°æ¯”æ˜é¡¯ã€åœ“å½¢è£åˆ‡ã€é©åˆä½œç‚ºé ­åƒ';
      case 'è³½åšé¾å…‹': return 'è³½åšé¾å…‹éœ“è™¹ã€è—ç´«åå…‰ã€é‡‘å±¬è³ªæ„Ÿã€åœ“å½¢è£åˆ‡';
      case 'æ—¥ç³»æ‰å¹³': return 'æ—¥ç³»æ‰å¹³æ’ç•«ã€ç°¡æ½”è‰²å¡Šã€åœ“å½¢è£åˆ‡';
      case 'ç«¥è©±å¡é€š': return 'ç«¥è©±å¡é€šã€æº«æš–è‰²ç³»ã€æŸ”ç„¦èƒŒæ™¯ã€åœ“å½¢è£åˆ‡';
      default: return 'å¯æ„›æ’ç•«é¢¨æ ¼ï¼Œä¿ç•™è‡‰éƒ¨ç‰¹å¾µï¼Œåœ“å½¢è£åˆ‡ï¼ŒæŸ”å’Œç‡ˆå…‰ï¼Œæ·ºæ™¯æ·±èƒŒæ™¯';
    }
  }
  async function generateAI(which){
    const bubble = which==='A'?bubbleA:bubbleB;
    const useAI  = which==='A'?useAIA?.checked:useAIB?.checked;
    const styleSel = which==='A'?styleA:styleB;
    const strength = which==='A'?(parseInt(strengthA?.value||'70')||70):(parseInt(strengthB?.value||'70')||70);
    const btn = which==='A'?genAIA:genAIB;
    const revertBtn = which==='A'?revertA:revertB;

    const curURL = getCurrentBubble(bubble);
    const base64 = curURL?.startsWith('data:image') ? dataURLtoBase64(curURL) : null;
    if(!base64){ showToast('è«‹å…ˆä¸Šå‚³ç…§ç‰‡'); return; }

    btn.disabled = true; btn.textContent = 'ç”Ÿæˆä¸­â€¦';
    try{
      const resp = await fetch('/api/ai-avatar',{
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ imageBase64: base64, prompt: styleToPrompt(styleSel?.value||''), strength })
      });
      const data = await resp.json();
      if(!resp.ok || !data?.imageBase64) throw new Error(data?.error || 'AI ç”Ÿæˆå¤±æ•—');
      const dataUrl = 'data:image/png;base64,' + data.imageBase64;
      if(which==='A'){ if(!originalA) originalA = curURL; aiA = dataUrl; }
      else { if(!originalB) originalB = curURL; aiB = dataUrl; }
      if(useAI) setBubbleFromURL(bubble, dataUrl);
      showToast('AI é ­åƒå·²å®Œæˆ'); revertBtn.disabled = false;
    }catch(e){ console.error(e); showToast('ç”Ÿæˆå¤±æ•—ï¼š'+(e.message||e));
    }finally{ btn.disabled=false; btn.textContent='æ›æˆAIé ­åƒ'; }
  }
  if(genAIA) genAIA.addEventListener('click', ()=>generateAI('A'));
  if(genAIB) genAIB.addEventListener('click', ()=>generateAI('B'));
  if(revertA) revertA.addEventListener('click', ()=>{ if(originalA){ setBubbleFromURL(bubbleA, originalA); useAIA.checked=false; } });
  if(revertB) revertB.addEventListener('click', ()=>{ if(originalB){ setBubbleFromURL(bubbleB, originalB); useAIB.checked=false; } });
  if(useAIA) useAIA.addEventListener('change', ()=>{ if(useAIA.checked && aiA) setBubbleFromURL(bubbleA, aiA); else if(originalA) setBubbleFromURL(bubbleA, originalA); });
  if(useAIB) useAIB.addEventListener('change', ()=>{ if(useAIB.checked && aiB) setBubbleFromURL(bubbleB, aiB); else if(originalB) setBubbleFromURL(bubbleB, originalB); });
  if(strengthA) strengthA.addEventListener('input', ()=>{ strengthATip.textContent = strengthA.value; });
  if(strengthB) strengthB.addEventListener('input', ()=>{ strengthBTip.textContent = strengthB.value; });

  // ========== ä¸Šå‚³ï¼ˆServerless ä»£ç†åˆ° Supabaseï¼‰==========
  async function getBase64FromBubble(bubble){
    const url = getCurrentBubble(bubble);
    if(!url) return null;
    if (url.startsWith('data:image')) return dataURLtoBase64(url);
    // é dataURL å˜—è©¦æŠ“å–è½‰ base64ï¼ˆå¯èƒ½è¢« CORS æ“‹ï¼Œæ“‹åˆ°æ™‚å› nullï¼‰
    return await urlToBase64(url);
  }
  async function uploadViaApi(which, base64, shareId, payload){
    const filename = `${shareId}-${which}.png`;
    const r = await fetch('/api/upload-avatar', {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ imageBase64: base64, filename, payload })
    });
    const j = await r.json();
    if(!r.ok) throw new Error(j?.error || 'server error');
    return j?.publicUrl || null;
  }

shareBtn.addEventListener('click', async () => {
  const id = ensureShareId();
  const aName = (nameA?.value || '').trim() || 'A';
  const bName = (nameB?.value || '').trim() || 'B';
  const sDate = start?.value || null;
  const payload = { slug: id, name_a: aName, name_b: bName, start_date: sDate, is_public: true };

  try {
    showToast('ä¸Šå‚³é ­åƒä¸­â€¦');

    const [a64, b64] = await Promise.all([
      getBase64FromBubble(bubbleA),
      getBase64FromBubble(bubbleB),
    ]);

    const jobs = [];
    if (a64) jobs.push(uploadViaApi('A', a64, id, payload));
    if (b64) jobs.push(uploadViaApi('B', b64, id, payload));

    if (!jobs.length) {
      const supa = await ensureSupabase();
      await supa.from('couples').upsert(payload, { onConflict: 'slug' });
    } else {
      await Promise.all(jobs);
    }

    const link = `${location.origin}/c/${id}?v=1`;
    await navigator.clipboard?.writeText(link);
    showToast('å·²è¤‡è£½åˆ†äº«é€£çµï¼ˆå«é ­åƒï¼‰');
  } catch (e) {
    console.error(e);
    showToast('åˆ†äº«å¤±æ•—ï¼š' + (e.message || e));
  }
});


  // ========== é‡è¨­ / AI é¢æ¿ ==========
  resetBtn.addEventListener('click', ()=>{
    nameA.value=''; nameB.value=''; start.value='';
    prevA.innerHTML='ğŸ–¼ï¸'; prevB.innerHTML='ğŸ–¼ï¸';
    bubbleA.style.backgroundImage='none'; bubbleB.style.backgroundImage='none';
    daysEl.textContent='0'; namesEl.textContent='è¨±çš“éˆ Ã— Sunny'; subEl.textContent='æŒ‰ä¸‹ã€Œé–‹å§‹ã€çœ‹çœ‹ä»Šå¤©ç¬¬å¹¾å¤© âœ¨';
    localStorage.removeItem('love-counter'); originalA = originalB = aiA = aiB = null;
  });
  aiToggleBtn.addEventListener('click', ()=>{
    document.body.classList.toggle('ai-open');
    aiToggleBtn.textContent = document.body.classList.contains('ai-open') ? 'éš±è— AI å·¥å…·' : 'AI å·¥å…·';
  });
</script>

</body>
</html>
